<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Carrinho de Compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Firebase compat scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f6f6; margin:0; padding:30px;}
    h1   { color: #333; }
    table { width:100%; background:#fff; border-radius:6px; box-shadow:0 0 8px #0001; margin-bottom:25px;}
    th,td { padding:10px; border-bottom:1px solid #eee;}
    th { background: #007bff; color:white;}
    td img { max-width: 60px; }
    button { background: #007bff; color:white; border:none; border-radius:4px; padding:8px 16px; margin:5px 0; cursor:pointer;}
    button:hover { background: #0056b3;}
    .empty { color: #aaa; font-size: 18px;}
  </style>
</head>
<body>
  <h1>Seu Carrinho</h1>
  <table id="tabelaCarrinho">
    <thead>
      <tr>
        <th>Imagem</th>
        <th>Produto</th>
        <th>Quantidade</th>
        <th>Preço</th>
        <th>Subtotal</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody>
      <!-- Itens adicionados via JS -->
    </tbody>
  </table>
  <div id="total"></div>
  <button onclick="finalizarPedido()">Finalizar Pedido</button>
  <button onclick="logout()">Sair</button>

  <script>
    // IIFE para carregar config e garantir execução correta
    (async () => {
      // Busca config do Firebase igual login.html
      const resp = await fetch('/config/firebase');
      const cfg = await resp.json();
      firebase.initializeApp(cfg);

      let user, token;

      firebase.auth().onAuthStateChanged(async (u) => {
        if (!u) {
          alert('Você precisa estar logado para acessar o carrinho.');
          window.location.href = '/login';
          return;
        }
        user = u;
        token = await user.getIdToken();
        carregarCarrinho();
      });

      async function carregarCarrinho() {
        try {
          const res = await fetch('/api/cart', {
            headers: { Authorization: `Bearer ${token}` }
          });
          const itens = await res.json();
          const tbody = document.querySelector('#tabelaCarrinho tbody');
          tbody.innerHTML = '';
          let total = 0;

          if (!Array.isArray(itens) || !itens.length) {
            tbody.innerHTML = `<tr><td colspan="6" class="empty">Carrinho vazio.</td></tr>`;
          } else {
            itens.forEach(item => {
              const subtotal = item.produto.preco * item.quantidade;
              total += subtotal;
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><img src="${item.produto.imagemUrl}" alt="Imagem"></td>
                <td>${item.produto.nome}</td>
                <td>${item.quantidade}</td>
                <td>R$ ${item.produto.preco.toFixed(2)}</td>
                <td>R$ ${subtotal.toFixed(2)}</td>
                <td><button onclick="removerItem(${item.id})">Remover</button></td>
              `;
              tbody.appendChild(tr);
            });
          }
          document.getElementById('total').innerHTML = `<b>Total:</b> R$ ${total.toFixed(2)}`;
        } catch (err) {
          alert('Erro ao carregar carrinho.');
        }
      }

      // Torna função global para uso inline no onclick
      window.removerItem = async function(id) {
        if (!confirm('Remover este item?')) return;
        await fetch(`/api/cart/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });
        carregarCarrinho();
      };

      window.finalizarPedido = async function() {
        if (!confirm('Deseja finalizar o pedido?')) return;
        try {
          const res = await fetch('/api/cart/checkout', {
            method: 'POST',
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) {
            const erro = await res.json();
            alert('❌ ' + (erro.error || 'Erro ao finalizar pedido'));
            return;
          }
          alert('✅ Pedido finalizado com sucesso!');
          window.location.href = '/meus-pedidos.html';
        } catch (err) {
          alert('Erro inesperado no checkout.');
        }
      };

      window.logout = function() {
        firebase.auth().signOut().then(() => window.location.href = '/login');
      };

    })();
  </script>
</body>
</html>
