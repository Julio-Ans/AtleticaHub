<!-- admin-dashboard.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .message-card {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .message-card.fixed {
      background-color: #f8f9fa;
      border-left: 3px solid #007bff;
    }
    button {
      padding: 8px 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    button.reject {
      background: #f44336;
    }
    button.fix {
      background: #2196F3;
    }
    #esporteSelector {
      padding: 8px;
      margin-bottom: 15px;
    }
    #modalMensagens {
      border: 1px solid #ddd;
      padding: 20px;
      margin-top: 20px;
      border-radius: 5px;
    }
    #novaMensagem {
      width: 100%;
      min-height: 60px;
      margin-bottom: 10px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 15px;
      border: 1px solid #ddd;
      background: #f5f5f5;
      cursor: pointer;
    }
    .tab.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-control {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .btn {
      padding: 10px 15px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary {
      background: #007bff;
    }
    .btn-danger {
      background: #f44336;
    }
    .mensagens-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 4px;
      background: #f9f9f9;
    }

    .mensagem-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .esporte-selector {
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .mensagens-lista {
      flex: 1;
    }

    .mensagens-container {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .mensagem {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 3px solid #ddd;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .mensagem.fixada {
      border-left: 3px solid #007bff;
      background-color: #f8f9fa;
    }

    .mensagem-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .mensagem-conteudo {
      margin-bottom: 15px;
      white-space: pre-wrap;
    }

    .mensagem-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #666;
      font-size: 0.9em;
    }

    .mensagem-acoes {
      display: flex;
      gap: 8px;
    }

    .nova-mensagem {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-fixar {
      background: #17a2b8;
    }

    .carregando {
      text-align: center;
      color: #666;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h1>Dashboard do Administrador</h1>
      <button class="reject" onclick="logout()">Sair</button>
    </div>
      <div class="tabs">
      <div class="tab active" onclick="changeTab('inscricoes')">Inscri√ß√µes</div>
      <div class="tab" onclick="changeTab('mensagens')">Mensagens</div>
      <div class="tab" onclick="changeTab('esportes')">Gerenciar Esportes</div>
      <div class="tab" onclick="changeTab('eventos')">Gerenciar Eventos</div>
      <div class="tab" onclick="changeTab('loja')">Gerenciar Loja</div>
    </div>
    
    <div id="inscricoesTab">
      <!-- Seletor de esportes -->
      <h2>Inscri√ß√µes Pendentes</h2>
      <select id="esporteSelector" onchange="carregarPendentes(this.value)">
        <option value="">Selecione um esporte...</option>
      </select>
      <div id="listaInscricoes" class="card">
        <p>Selecione um esporte para ver as inscri√ß√µes pendentes.</p>
      </div>
    </div>
    
    <div id="mensagensTab" style="display:none">
      <h2>Gerenciar Mensagens</h2>
      
      <div class="card mensagem-container">
        <!-- Seletor de esporte -->
        <div class="esporte-selector">
          <label for="esporteMensagens">Selecione o Esporte:</label>
          <select id="esporteMensagens" class="form-control" onchange="mudarEsporteMensagens(this.value)">
            <option value="0">Geral (Todos os Esportes)</option>
            <!-- Outros esportes ser√£o carregados dinamicamente -->
          </select>
        </div>
        
        <!-- Lista de mensagens -->
        <div class="mensagens-lista">
          <h3>Mensagens <span id="esporteAtual">Gerais</span></h3>
          <div id="listaMensagens" class="mensagens-container">
            <p class="carregando">Carregando mensagens...</p>
          </div>
        </div>
        
        <!-- Campo para enviar nova mensagem -->
        <div class="nova-mensagem">
          <h3>Enviar Nova Mensagem</h3>
          <textarea id="mensagemTexto" class="form-control" rows="3" placeholder="Digite sua mensagem aqui..."></textarea>
          <button onclick="enviarMensagem()" class="btn btn-primary">Enviar Mensagem</button>
        </div>
      </div>
    </div>
      <div id="esportesTab" style="display:none">
      <h2>Gerenciar Esportes</h2>
      <div class="card">
        <h3>Adicionar Novo Esporte</h3>
        <input type="text" id="novoEsporteNome" placeholder="Nome do esporte">
        <input type="file" id="novoEsporteFoto" accept="image/*" placeholder="Foto do esporte (opcional)">
        <button onclick="adicionarEsporte()">Adicionar</button>
      </div>
      <div id="listaEsportes">
        <p>Carregando esportes...</p>
      </div>
    </div>
      <div id="eventosTab" style="display:none">
      <h2>Gerenciar Eventos</h2>
      <div class="card">
        <h3>Criar Novo Evento</h3>        <div class="form-group">
          <input type="text" id="eventoTitulo" class="form-control" placeholder="T√≠tulo do evento">
          <input type="text" id="eventoDescricao" class="form-control" placeholder="Descri√ß√£o (opcional)">
          <select id="eventoTipo" class="form-control" style="margin-bottom: 10px;" onchange="mostrarSubopcoes()">
            <option value="">Selecione o tipo de evento...</option>
            <option value="geral">Geral</option>
            <option value="treino">Treino</option>
          </select>
          <select id="eventoSubtipo" class="form-control" style="margin-bottom: 10px; display: none;">
            <option value="">Selecione...</option>
          </select>
          <input type="datetime-local" id="eventoData" class="form-control" placeholder="Data e hora">
          <input type="text" id="eventoLocal" class="form-control" placeholder="Local">
          <input type="file" id="eventoFoto" class="form-control" accept="image/*">
        </div>
        <button onclick="criarEvento()">Criar Evento</button>
      </div>
      <div id="listaEventosAdmin">
        <p>Carregando eventos...</p>
      </div>
    </div>

    <div id="lojaTab" style="display:none">
      <h2>Gerenciar Loja</h2>
      
      <!-- A√ß√µes r√°pidas -->
      <div class="card">
        <h3>A√ß√µes R√°pidas</h3>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="window.location.href='/cadastrar-produto.html'">
            ‚ûï Cadastrar Novo Produto
          </button>
          <button class="btn btn-primary" onclick="window.location.href='/listar-produtos.html'">
            üì¶ Gerenciar Produtos
          </button>
          <button class="btn btn-primary" onclick="carregarRelatorioVendas()">
            üìä Atualizar Relat√≥rio
          </button>
        </div>
      </div>

      <!-- Estat√≠sticas da loja -->
      <div class="card">
        <h3>Estat√≠sticas da Loja</h3>
        <div id="estatisticasLoja" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div style="text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
            <h4 id="totalProdutos">-</h4>
            <p>Total de Produtos</p>
          </div>
          <div style="text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
            <h4 id="totalPedidos">-</h4>
            <p>Total de Pedidos</p>
          </div>
          <div style="text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
            <h4 id="vendasMes">-</h4>
            <p>Vendas do M√™s</p>
          </div>
        </div>
      </div>

      <!-- Pedidos recentes -->
      <div class="card">
        <h3>Pedidos Recentes</h3>
        <div id="pedidosRecentesContainer" class="carregando">Carregando pedidos...</div>
      </div>

      <!-- Relat√≥rio de vendas por produto -->
      <div class="card">
        <h3>Relat√≥rio de Vendas por Produto</h3>
        <div id="relatorioVendas" class="carregando">Carregando relat√≥rio...</div>
      </div>
    </div>  </div>

  <script>
    const esporteGeralId = "0"; // N√∫mero em vez de string
    let firebaseUser;
    let currentTab = 'inscricoes';    async function main() {
      try {
        // Carregar configura√ß√£o do Firebase do servidor
        const resp = await fetch('/config/firebase');
        const firebaseConfig = await resp.json();
        firebase.initializeApp(firebaseConfig);

        // Configurar autentica√ß√£o
        firebase.auth().onAuthStateChanged(async user => {
          if (!user) {
            return window.location.href = '/login';
          }
          
          firebaseUser = user;
          const verificado = await verificarAcessoAdmin();          if (verificado) {
            await carregarEsportes();
            await carregarEsportesParaMensagens();
            await mudarEsporteMensagens("0");
            await carregarEventosAdmin();
          }
        });
      } catch (err) {
        console.error('Erro ao inicializar:', err);
        alert('Erro ao carregar a p√°gina. Por favor, tente novamente.');
      }
    }

    async function verificarAcessoAdmin() {
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch('/auth/verify-admin', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) {
          alert('Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.');
          window.location.href = '/user-dashboard';
          return false;
        }
        
        return true;
      } catch (err) {
        console.error('Erro de verifica√ß√£o:', err);
        alert('Erro ao verificar suas credenciais de administrador.');
        window.location.href = '/login';
        return false;
      }
    }    function changeTab(tab) {
      // Ocultar todas as abas
      document.getElementById('inscricoesTab').style.display = 'none';
      document.getElementById('mensagensTab').style.display = 'none';
      document.getElementById('esportesTab').style.display = 'none';
      document.getElementById('eventosTab').style.display = 'none';
      document.getElementById('lojaTab').style.display = 'none';
      
      // Remover classe ativa de todas as abas
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      
      // Mostrar a aba selecionada
      document.getElementById(`${tab}Tab`).style.display = 'block';
      
      // Adicionar classe ativa √† aba selecionada
      document.querySelector(`.tab[onclick="changeTab('${tab}')"]`).classList.add('active');
      
      // Carregar dados espec√≠ficos da aba
      if (tab === 'loja') {
        carregarDadosLoja();
      }
      
      currentTab = tab;
    }

    async function carregarEsportes() {
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch('/api/esportes', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error('Falha ao carregar esportes');
        }
        
        const esportes = await res.json();
        
        // Preencher o seletor de esportes
        const selector = document.getElementById('esporteSelector');
        selector.innerHTML = '<option value="">Selecione um esporte...</option>';
        
        esportes.forEach(esporte => {
          const option = document.createElement('option');
          option.value = esporte.id;
          option.textContent = esporte.nome;
          selector.appendChild(option);
        });
        
          // Preencher a lista de esportes para gerenciamento
        const listaEsportes = document.getElementById('listaEsportes');
        listaEsportes.innerHTML = '';
        
        esportes.forEach(esporte => {
          const div = document.createElement('div');
          div.className = 'card';
          
          let fotoHtml = '';
          if (esporte.fotoUrl) {
            fotoHtml = `<img src="${esporte.fotoUrl}" alt="${esporte.nome}" style="max-width: 100px; max-height: 100px; margin-bottom: 10px; border-radius: 5px;">`;
          }
          
          div.innerHTML = `
            ${fotoHtml}
            <h3>${esporte.nome}</h3>
            <button onclick="editarEsporte('${esporte.id}')">Editar</button>
            <button class="reject" onclick="removerEsporte('${esporte.id}')">Remover</button>
          `;
          listaEsportes.appendChild(div);
        });      } catch (err) {
        console.error('Erro ao carregar esportes:', err);
        alert('Erro ao carregar a lista de esportes.');
      }
    }

    function mostrarSubopcoes() {
      const tipoSelect = document.getElementById('eventoTipo');
      const subtipoSelect = document.getElementById('eventoSubtipo');
      const tipoSelecionado = tipoSelect.value;
      
      // Limpar op√ß√µes anteriores
      subtipoSelect.innerHTML = '<option value="">Selecione...</option>';
      
      if (tipoSelecionado === 'geral') {
        // Mostrar subtipos para eventos gerais
        subtipoSelect.style.display = 'block';
        const subtiposGerais = [
          { value: 'reuniao', text: 'Reuni√£o' },
          { value: 'festa', text: 'Festa' },
          { value: 'confraternizacao', text: 'Confraterniza√ß√£o' },
          { value: 'palestra', text: 'Palestra' },
          { value: 'workshop', text: 'Workshop' },
          { value: 'assembleia', text: 'Assembleia' },
          { value: 'outro', text: 'Outro' }
        ];
        
        subtiposGerais.forEach(subtipo => {
          const option = document.createElement('option');
          option.value = subtipo.value;
          option.textContent = subtipo.text;
          subtipoSelect.appendChild(option);
        });
        
      } else if (tipoSelecionado === 'treino') {
        // Mostrar esportes para treinos
        subtipoSelect.style.display = 'block';
        carregarEsportesParaTreino();
        
      } else {
        // Esconder subtipo se nenhum tipo foi selecionado
        subtipoSelect.style.display = 'none';
      }
    }

    async function carregarEsportesParaTreino() {
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch('/api/esportes', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error('Falha ao carregar esportes');
        }
        
        const esportes = await res.json();
        const subtipoSelect = document.getElementById('eventoSubtipo');
        
        // Limpar e adicionar esportes
        subtipoSelect.innerHTML = '<option value="">Selecione o esporte...</option>';
        
        esportes.forEach(esporte => {
          const option = document.createElement('option');
          option.value = esporte.id;
          option.textContent = esporte.nome;
          subtipoSelect.appendChild(option);
        });
        
      } catch (err) {
        console.error('Erro ao carregar esportes para treino:', err);
      }
    }

    async function carregarPendentes(esporteId) {
      if (!esporteId) {
        document.getElementById('listaInscricoes').innerHTML = 
          '<p>Selecione um esporte para ver as inscri√ß√µes pendentes.</p>';
        return;
      }
      
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch(`/api/inscricoes/pendentes/${esporteId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error('Falha ao carregar inscri√ß√µes pendentes');
        }
        
        const inscricoes = await res.json();
        const lista = document.getElementById('listaInscricoes');
        
        if (inscricoes.length === 0) {
          lista.innerHTML = '<p>N√£o h√° inscri√ß√µes pendentes para este esporte.</p>';
          return;
        }
        
        lista.innerHTML = '';
        inscricoes.forEach(i => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <h3>${i.usuario.nome}</h3>
            <p>Curso: ${i.usuario.curso}</p>
            <p>Telefone: ${i.usuario.telefone}</p>
            <p>Data de inscri√ß√£o: ${new Date(i.criadaEm).toLocaleString()}</p>
            <div>
              <button onclick="atualizarStatus('${i.id}', 'aceito')">Aceitar</button>
              <button class="reject" onclick="atualizarStatus('${i.id}', 'recusado')">Recusar</button>
            </div>
          `;
          lista.appendChild(div);
        });
      } catch (err) {
        console.error('Erro ao carregar pendentes:', err);
        document.getElementById('listaInscricoes').innerHTML = 
          '<p>Erro ao carregar inscri√ß√µes pendentes. Por favor, tente novamente.</p>';
      }
    }

    async function atualizarStatus(id, status) {
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch(`/api/inscricoes/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ status })
        });
        
        if (!res.ok) {
          throw new Error('Falha ao atualizar status');
        }
        
        alert(`Inscri√ß√£o ${status === 'aceito' ? 'aceita' : 'recusada'} com sucesso!`);
        
        // Recarregar a lista de pendentes
        const esporteId = document.getElementById('esporteSelector').value;
        await carregarPendentes(esporteId);
      } catch (err) {
        console.error('Erro ao atualizar status:', err);
        alert(`Erro ao ${status === 'aceito' ? 'aceitar' : 'recusar'} inscri√ß√£o.`);
      }
    }

    async function carregarMensagens() {
      try {
        const container = document.getElementById('listaMensagens');
        if (!container) {
          console.error("Elemento 'listaMensagens' n√£o encontrado");
          return;
        }
        
        container.innerHTML = '<p class="carregando">Carregando mensagens...</p>';
        
        const token = await firebaseUser.getIdToken();
        const esporteId = document.getElementById('esporteMensagens').value;
        const url = `/api/mensagens/${esporteId}`; 
        
        console.log("Buscando mensagens de:", url);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro ao carregar mensagens: ${response.status} ${response.statusText}`);
        }
        
        const mensagens = await response.json();
        
        if (mensagens.length === 0) {
          container.innerHTML = '<p class="text-muted">N√£o h√° mensagens para exibir.</p>';
          return;
        }
        
        container.innerHTML = '';
        console.log("Mensagens recebidas:", mensagens);
        
        mensagens.forEach(msg => {
          // Verificar o formato do ID
          console.log(`Mensagem: ID=${msg._id || msg.id}, conte√∫do=${msg.texto || msg.conteudo}`);
          
          // Corrigir para usar o formato correto de ID do MongoDB
          const messageId = msg._id || msg.id;
          
          if (!messageId) {
            console.error("Mensagem sem ID detectada:", msg);
          }
          
          const div = document.createElement('div');
          div.className = msg.fixada ? 'mensagem fixada' : 'mensagem';
          div.innerHTML = `
            <div class="mensagem-header">
              <strong>${msg.usuario?.nome || msg.usuarioNome || 'Usu√°rio'}</strong>
              ${msg.fixada ? '<span class="badge badge-info">Fixada</span>' : ''}
            </div>
            <div class="mensagem-conteudo">${msg.texto || msg.conteudo}</div>          <div class="mensagem-footer">
              <span>Enviada em ${new Date(msg.criadaEm).toLocaleString()}</span>
              <span style="font-size: smaller; color: #888;">ID: ${messageId}</span>
              <div class="mensagem-acoes">
                <button class="btn btn-sm ${msg.fixada ? 'btn-warning' : 'btn-fixar'}" 
                        onclick="fixarMensagem('${messageId}', ${!msg.fixada})">
                  ${msg.fixada ? 'Desafixar' : 'Fixar'}
                </button>
                <button class="btn btn-sm btn-danger" onclick="excluirMensagem('${messageId}')">
                  Excluir
                </button>
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error('Erro ao carregar mensagens:', err);
        const container = document.getElementById('listaMensagens');
        if (container) {
          container.innerHTML = `<div class="alert alert-danger">Erro ao carregar mensagens: ${err.message}</div>`;
        }
      }
    }

    async function enviarMensagem() {
      try {
        const mensagemTexto = document.getElementById('mensagemTexto').value.trim();
        const esporteId = document.getElementById('esporteMensagens').value;
        
        if (!mensagemTexto) {
          alert('Digite uma mensagem para enviar');
          return;
        }
        
        const token = await firebaseUser.getIdToken();
        
        // Usar a rota com o par√¢metro esporteId
        const response = await fetch(`/api/mensagens/${esporteId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            texto: mensagemTexto,  // Usamos 'texto' em vez de 'conteudo'
            conteudo: mensagemTexto // Enviamos ambos para garantir compatibilidade
          })
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Falha ao enviar mensagem');
        }
        
        document.getElementById('mensagemTexto').value = '';
        await carregarMensagens();
        
        alert('Mensagem enviada com sucesso!');
      } catch (err) {
        console.error('Erro ao enviar mensagem:', err);
        alert(`Erro ao enviar mensagem: ${err.message}`);
      }
    }    async function fixarMensagem(id, fixada) {
      try {
        // Garantir que temos um ID v√°lido
        if (!id) {
          throw new Error('ID da mensagem n√£o fornecido');
        }
        
        console.log("Tentando fixar/desfixar mensagem com ID:", id, "Fixada:", fixada);
        const token = await firebaseUser.getIdToken();
        
        // Removendo caracteres problem√°ticos ou espa√ßos em branco
        const sanitizedId = id.toString().trim();
        
        const res = await fetch(`/api/mensagens/${encodeURIComponent(sanitizedId)}/fixar`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ fixada })
        });
        
        // Exibe detalhes completos da resposta para debug
        console.log("Resposta da opera√ß√£o fixar:", {
          status: res.status,
          statusText: res.statusText,
          headers: [...res.headers].reduce((obj, [key, val]) => ({...obj, [key]: val}), {})
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(e => ({ error: "N√£o foi poss√≠vel ler o corpo da resposta" }));
          console.error("Detalhes do erro:", errorData);
          throw new Error(`Falha ao fixar/desfixar mensagem: ${res.status} ${errorData.error || res.statusText}`);
        }
        
        await carregarMensagens();
        console.log("Mensagem atualizada com sucesso!");
      } catch (err) {
        console.error('Erro ao fixar/desfixar mensagem:', err);
        alert(`Erro ao fixar/desfixar mensagem: ${err.message}`);
      }
    }async function excluirMensagem(id) {
      if (!confirm('Tem certeza que deseja excluir esta mensagem?')) {
        return;
      }
      
      try {
        // Garantir que temos um ID v√°lido
        if (!id) {
          throw new Error('ID da mensagem n√£o fornecido');
        }
        
        console.log("Tentando excluir mensagem com ID:", id);
        const token = await firebaseUser.getIdToken();
        
        // Removendo caracteres problem√°ticos ou espa√ßos em branco
        const sanitizedId = id.toString().trim();
        
        const res = await fetch(`/api/mensagens/${encodeURIComponent(sanitizedId)}`, {
          method: 'DELETE',
          headers: { 
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        // Exibe detalhes completos da resposta para debug
        console.log("Resposta da exclus√£o:", {
          status: res.status,
          statusText: res.statusText,
          headers: [...res.headers].reduce((obj, [key, val]) => ({...obj, [key]: val}), {})
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(e => ({ error: "N√£o foi poss√≠vel ler o corpo da resposta" }));
          console.error("Detalhes do erro:", errorData);
          throw new Error(`Falha ao excluir mensagem: ${res.status} ${errorData.error || res.statusText}`);
        }
        
        await carregarMensagens();
        alert("Mensagem exclu√≠da com sucesso!");
      } catch (err) {
        console.error('Erro ao excluir mensagem:', err);
        alert(`Erro ao excluir mensagem: ${err.message}`);
      }
    }    async function adicionarEsporte() {
      try {
        const nome = document.getElementById('novoEsporteNome').value.trim();
        const fotoInput = document.getElementById('novoEsporteFoto');
        
        if (!nome) {
          return alert('Por favor, digite um nome para o esporte.');
        }
        
        const token = await firebaseUser.getIdToken();
        
        // Criar FormData para enviar arquivo
        const formData = new FormData();
        formData.append('nome', nome);
        
        if (fotoInput.files[0]) {
          formData.append('foto', fotoInput.files[0]);
        }
        
        const res = await fetch('/api/esportes', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`
          },
          body: formData
        });
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Falha ao adicionar esporte');
        }
        
        document.getElementById('novoEsporteNome').value = '';
        document.getElementById('novoEsporteFoto').value = '';
        alert('Esporte adicionado com sucesso!');
        await carregarEsportes();
      } catch (err) {
        console.error('Erro ao adicionar esporte:', err);
        alert('Erro ao adicionar esporte: ' + err.message);
      }
    }

    async function editarEsporte(id) {
      const novoNome = prompt('Digite o novo nome para o esporte:');
      
      if (!novoNome) return;
      
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch(`/api/esportes/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ nome: novoNome })
        });
        
        if (!res.ok) {
          throw new Error('Falha ao editar esporte');
        }
        
        alert('Esporte atualizado com sucesso!');
        await carregarEsportes();
      } catch (err) {
        console.error('Erro ao editar esporte:', err);
        alert('Erro ao editar esporte.');
      }
    }

    async function removerEsporte(id) {
      if (!confirm('Tem certeza que deseja remover este esporte? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
      }
      
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch(`/api/esportes/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error('Falha ao remover esporte');
        }
        
        alert('Esporte removido com sucesso!');
        await carregarEsportes();
      } catch (err) {
        console.error('Erro ao remover esporte:', err);
        alert('Erro ao remover esporte.');
      }
    }

    async function logout() {
      try {
        await firebase.auth().signOut();
        window.location.href = '/login';
      } catch (err) {
        console.error('Erro ao fazer logout:', err);
        alert('Erro ao fazer logout. Por favor, tente novamente.');
      }
    }    // Carregar esportes para o seletor de mensagens
    async function carregarEsportesParaMensagens() {
      try {
        const token = await firebase.auth().currentUser.getIdToken();
        const response = await fetch('/api/esportes', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar esportes');
        }
        
        const esportes = await response.json();
        
        // Preencher o seletor de envio de mensagens
        const seletor = document.getElementById('esporteMensagens');
        if (!seletor) {
          console.error("Elemento 'esporteMensagens' n√£o encontrado");
          return;
        }
        
        // Manter apenas a op√ß√£o "Geral"
        seletor.innerHTML = '<option value="0">Geral (Todos os Esportes)</option>';
        
        // Adicionar os esportes ao seletor
        esportes.forEach(esporte => {
          // Pular "Geral" no seletor de envio pois j√° foi adicionado
          if (esporte.id !== "0") {
            const option = document.createElement('option');
            option.value = esporte.id;
            option.textContent = esporte.nome;
            seletor.appendChild(option);
          }
        });
        
      } catch (error) {
        console.error('Erro ao carregar esportes:', error);
        alert('Erro ao carregar esportes: ' + error.message);
      }
    }

    // Muda o esporte e carrega as mensagens dele
    async function mudarEsporteMensagens(esporteId) {
      try {
        // Atualizar o t√≠tulo da se√ß√£o de mensagens
        const select = document.getElementById('esporteMensagens');
        const option = select.options[select.selectedIndex];
        const nomeEsporte = option ? option.text : "Geral";
        
        document.getElementById('esporteAtual').textContent = nomeEsporte;
        
        // Recarregar as mensagens
        await carregarMensagens();
      } catch (error) {
        console.error('Erro ao mudar esporte:', error);
      }
    }    async function carregarEventosAdmin() {
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch('/api/eventos', { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error('Erro ao carregar eventos');
        const eventos = await res.json();
        const lista = document.getElementById('listaEventosAdmin');
        if (!eventos.length) {
          lista.innerHTML = '<p>Nenhum evento cadastrado.</p>';
          return;
        }
        lista.innerHTML = '';
        eventos.forEach(ev => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <h3>${ev.titulo}</h3>
            ${ev.fotoUrl ? `<img src="${ev.fotoUrl}" alt="Foto do evento" style="max-width:200px;max-height:150px;display:block;margin-bottom:10px;">` : ''}
            <p><b>Tipo:</b> ${ev.tipo} | <b>Data:</b> ${new Date(ev.data).toLocaleString()} | <b>Local:</b> ${ev.local}</p>
            <p>${ev.descricao || ''}</p>
            <button onclick="editarEvento('${ev._id}')">Editar</button>
            <button class="btn-danger" onclick="removerEvento('${ev._id}')">Remover</button>
            <details><summary>Ver inscritos</summary>
              <ul>${(ev.inscricoes||[]).map(i=>`<li>${i.nome||i.usuarioId} (${i.email||''})</li>`).join('')}</ul>
            </details>
          `;
          lista.appendChild(div);
        });
      } catch (err) {
        document.getElementById('listaEventosAdmin').innerHTML = '<p>Erro ao carregar eventos.</p>';
      }
    }    async function criarEvento() {
      try {
        const titulo = document.getElementById('eventoTitulo').value.trim();
        const descricao = document.getElementById('eventoDescricao').value.trim();
        const tipoEvento = document.getElementById('eventoTipo').value;
        const subtipo = document.getElementById('eventoSubtipo').value;
        const data = document.getElementById('eventoData').value;
        const local = document.getElementById('eventoLocal').value.trim();
        const foto = document.getElementById('eventoFoto').files[0];
        
        if (!titulo || !tipoEvento || !subtipo || !data || !local) {
          return alert('Preencha todos os campos obrigat√≥rios!');
        }
        
        // Determinar tipo e esporteId baseado na sele√ß√£o
        let tipo, esporteId;
        
        if (tipoEvento === 'geral') {
          tipo = subtipo; // reuniao, festa, etc.
          esporteId = '0'; // Eventos gerais t√™m esporteId = 0
        } else if (tipoEvento === 'treino') {
          tipo = 'treino';
          esporteId = subtipo; // ID do esporte selecionado
        }
        
        const token = await firebaseUser.getIdToken();
        const formData = new FormData();
        formData.append('titulo', titulo);
        formData.append('descricao', descricao);
        formData.append('tipo', tipo);
        formData.append('esporteId', esporteId);
        formData.append('data', data);
        formData.append('local', local);
        if (foto) {
          formData.append('foto', foto);
        }
        
        const res = await fetch('/api/eventos', {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Erro ao criar evento');
        }
        
        alert('Evento criado com sucesso!');
        document.getElementById('eventoTitulo').value = '';
        document.getElementById('eventoDescricao').value = '';
        document.getElementById('eventoTipo').value = '';
        document.getElementById('eventoSubtipo').value = '';
        document.getElementById('eventoSubtipo').style.display = 'none';
        document.getElementById('eventoData').value = '';
        document.getElementById('eventoLocal').value = '';
        document.getElementById('eventoFoto').value = '';
        await carregarEventosAdmin();
      } catch (err) {
        console.error('Erro ao criar evento:', err);
        alert(`Erro ao criar evento: ${err.message}`);
      }
    }

    async function removerEvento(id) {
      if (!confirm('Remover este evento?')) return;
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch(`/api/eventos/${id}`, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error('Erro ao remover evento');
        alert('Evento removido!');
        await carregarEventosAdmin();
      } catch (err) {
        alert('Erro ao remover evento.');
      }
    }

    async function editarEvento(id) {
      const novoTitulo = prompt('Novo t√≠tulo do evento:');
      if (!novoTitulo) return;
      try {
        const token = await firebaseUser.getIdToken();
        const res = await fetch(`/api/eventos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ titulo: novoTitulo })
        });
        if (!res.ok) throw new Error('Erro ao editar evento');
        alert('Evento atualizado!');
        await carregarEventosAdmin();
      } catch (err) {
        alert('Erro ao editar evento.');
      }
    }

    // ==================== FUN√á√ïES DA LOJA (ADMIN) ====================
    
    // Carregar todos os dados da loja
    async function carregarDadosLoja() {
      await Promise.all([
        carregarEstatisticasLoja(),
        carregarPedidosRecentes(),
        carregarRelatorioVendas()
      ]);
    }

    // Carregar estat√≠sticas da loja
    async function carregarEstatisticasLoja() {
      try {
        const token = await firebaseUser.getIdToken();
        
        // Carregar total de produtos
        const produtosRes = await fetch('/api/produtos', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (produtosRes.ok) {
          const produtosData = await produtosRes.json();
          document.getElementById('totalProdutos').textContent = produtosData.produtos?.length || 0;
        }
        
        // Carregar estat√≠sticas de pedidos
        const pedidosRes = await fetch('/api/pedidos/admin/estatisticas', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (pedidosRes.ok) {
          const pedidosData = await pedidosRes.json();
          document.getElementById('totalPedidos').textContent = pedidosData.totalPedidos || 0;
          document.getElementById('vendasMes').textContent = `R$ ${(pedidosData.vendasMes || 0).toFixed(2)}`;
        }
        
      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
      }
    }

    // Carregar pedidos recentes
    async function carregarPedidosRecentes() {
      try {
        const token = await firebaseUser.getIdToken();
        const response = await fetch('/api/pedidos/admin/recentes', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        const container = document.getElementById('pedidosRecentesContainer');
        
        if (!response.ok) {
          container.innerHTML = '<p>Erro ao carregar pedidos recentes.</p>';
          return;
        }
        
        const data = await response.json();
        const pedidos = data.pedidos || [];
        
        if (pedidos.length === 0) {
          container.innerHTML = '<p>Nenhum pedido recente.</p>';
          return;
        }
        
        container.innerHTML = `
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f8f9fa;">
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ID</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Cliente</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Total</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Status</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Data</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              ${pedidos.map(pedido => `
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;">#${pedido.id}</td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${pedido.usuario?.nome || pedido.usuario?.email || 'N/A'}</td>
                  <td style="padding: 8px; border: 1px solid #ddd;">R$ ${parseFloat(pedido.total).toFixed(2)}</td>
                  <td style="padding: 8px; border: 1px solid #ddd;">
                    <select onchange="atualizarStatusPedido(${pedido.id}, this.value)" style="padding: 4px;">
                      <option value="pendente" ${pedido.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                      <option value="processando" ${pedido.status === 'processando' ? 'selected' : ''}>Processando</option>
                      <option value="entregue" ${pedido.status === 'entregue' ? 'selected' : ''}>Entregue</option>
                      <option value="cancelado" ${pedido.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                    </select>
                  </td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${new Date(pedido.createdAt).toLocaleDateString('pt-BR')}</td>
                  <td style="padding: 8px; border: 1px solid #ddd;">
                    <button onclick="verDetalhesPedido(${pedido.id})" style="padding: 4px 8px; margin-right: 4px;">üëÅÔ∏è</button>
                    <button onclick="excluirPedido(${pedido.id})" class="btn-danger" style="padding: 4px 8px;">üóëÔ∏è</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        
      } catch (error) {
        console.error('Erro ao carregar pedidos recentes:', error);
        document.getElementById('pedidosRecentesContainer').innerHTML = '<p>Erro ao carregar pedidos.</p>';
      }
    }    // Atualizar status do pedido
    async function atualizarStatusPedido(pedidoId, novoStatus) {
      try {
        const token = await firebaseUser.getIdToken();
        const response = await fetch(`/api/pedidos/admin/${pedidoId}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ status: novoStatus })
        });
        
        if (!response.ok) {
          throw new Error('Erro ao atualizar status');
        }
        
        alert('Status atualizado com sucesso!');
        carregarPedidosRecentes(); // Recarregar lista
        
      } catch (error) {
        console.error('Erro ao atualizar status:', error);
        alert('Erro ao atualizar status do pedido.');
      }
    }

    // Ver detalhes do pedido
    async function verDetalhesPedido(pedidoId) {
      try {
        const token = await firebaseUser.getIdToken();
        const response = await fetch(`/api/pedidos/${pedidoId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar detalhes');
        }
        
        const data = await response.json();
        const pedido = data.pedido;
        
        let detalhes = `Pedido #${pedido.id}\n`;
        detalhes += `Cliente: ${pedido.usuario?.nome || pedido.usuario?.email || 'N/A'}\n`;
        detalhes += `Total: R$ ${parseFloat(pedido.total).toFixed(2)}\n`;
        detalhes += `Status: ${pedido.status}\n`;
        detalhes += `Data: ${new Date(pedido.createdAt).toLocaleString('pt-BR')}\n\n`;
        
        if (pedido.itens && pedido.itens.length > 0) {
          detalhes += 'Itens:\n';
          pedido.itens.forEach(item => {
            detalhes += `- ${item.produto?.nome || 'Produto n√£o encontrado'} (Qtd: ${item.quantidade})\n`;
          });
        }
        
        alert(detalhes);
        
      } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        alert('Erro ao carregar detalhes do pedido.');
      }
    }

    // Excluir pedido
    async function excluirPedido(pedidoId) {
      if (!confirm('Tem certeza que deseja excluir este pedido?')) {
        return;
      }
        try {
        const token = await firebaseUser.getIdToken();
        const response = await fetch(`/api/pedidos/admin/${pedidoId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error('Erro ao excluir pedido');
        }
        
        alert('Pedido exclu√≠do com sucesso!');
        carregarPedidosRecentes(); // Recarregar lista
        carregarEstatisticasLoja(); // Atualizar estat√≠sticas
        
      } catch (error) {
        console.error('Erro ao excluir pedido:', error);
        alert('Erro ao excluir pedido.');
      }
    }

    // Carregar relat√≥rio de vendas
    async function carregarRelatorioVendas() {
      try {
        const token = await firebaseUser.getIdToken();
        const response = await fetch('/api/pedidos/admin/relatorio-vendas', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        const container = document.getElementById('relatorioVendas');
        
        if (!response.ok) {
          container.innerHTML = '<p>Erro ao carregar relat√≥rio de vendas.</p>';
          return;
        }
        
        const data = await response.json();
        const relatorio = data.relatorio || [];
        
        if (relatorio.length === 0) {
          container.innerHTML = '<p>Nenhuma venda registrada.</p>';
          return;
        }
        
        container.innerHTML = `
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f8f9fa;">
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Produto</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Quantidade Vendida</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Receita Total</th>
              </tr>
            </thead>
            <tbody>
              ${relatorio.map(item => `
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;">${item.nome}</td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${item.totalVendido}</td>
                  <td style="padding: 8px; border: 1px solid #ddd;">R$ ${parseFloat(item.receita).toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        
      } catch (error) {
        console.error('Erro ao carregar relat√≥rio:', error);
        document.getElementById('relatorioVendas').innerHTML = '<p>Erro ao carregar relat√≥rio.</p>';
      }
    }

    // Iniciar a aplica√ß√£o
    main();
  </script>
</body>
</html>
