<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Mensagens - Atl√©ticaHub</title>
</head>
<body>
  <h2>Mensagens Privadas</h2>

  <p id="userInfo"></p>
  <button id="logoutBtn">Sair</button>

  <hr/>

  <h3>Enviar Nova Mensagem</h3>
  <input type="text" id="receiverId" placeholder="UID do destinat√°rio" />
  <input type="text" id="conteudo" placeholder="Conte√∫do da mensagem" />
  <button id="enviarBtn">Enviar</button>

  <hr/>

  <h3>Mensagens Enviadas</h3>
  <button id="btnVerEnviadas">Ver mensagens enviadas</button>
  <div id="mensagensEnviadas"></div>

  <hr/>

  <h3>Mensagens Recebidas (N√£o Lidas)</h3>
  <button id="btnVerNaoLidas">Ver mensagens n√£o lidas</button>
  <div id="mensagensNaoLidas"></div>

  <div id="notificacoes" style="margin-top: 20px;"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    let token = '';
    let currentUid = '';
    let db;

    async function init() {
      const resp = await fetch('/config/firebase');
      const config = await resp.json();
      firebase.initializeApp(config);
      db = firebase.database();

      const auth = firebase.auth();
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          alert('Voc√™ precisa estar logado.');
          return window.location.href = '/login.html';
        }

        token = await user.getIdToken();
        currentUid = user.uid;
        document.getElementById('userInfo').textContent = 'Logado como: ' + user.email;

        document.getElementById('logoutBtn').onclick = async () => {
          await auth.signOut();
          alert('Logout realizado!');
          window.location.href = '/login.html';
        };

        // Bot√µes dentro do init para garantir que existam
        document.getElementById('enviarBtn').onclick = enviarMensagem;
        document.getElementById('btnVerEnviadas').onclick = carregarMensagens;
        document.getElementById('btnVerNaoLidas').onclick = carregarNaoLidas;

        escutarMensagensEmTempoReal(currentUid);
      });
    }

    async function enviarMensagem() {
      const receiverId = document.getElementById('receiverId').value;
      const conteudo = document.getElementById('conteudo').value;

      const res = await fetch('/api/mensagens', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ receiverId, conteudo })
      });

      const data = await res.json();
      if (res.ok) {
        alert('‚úÖ Mensagem enviada!');
      } else {
        alert('Erro ao enviar mensagem');
        console.error(data);
      }
    }

    async function carregarMensagens() {
      const receiverId = document.getElementById('receiverId').value;

      const res = await fetch(`/api/mensagens/${receiverId}`, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      const data = await res.json();
      const container = document.getElementById('mensagensEnviadas');

      if (Array.isArray(data)) {
        container.innerHTML = '<ul>' + data
          .filter(m => m.senderId === currentUid)
          .map(m => `
            <li>
              <strong>Para (ID):</strong> ${m.receiverId}<br/>
              <strong>Conte√∫do:</strong> ${m.conteudo}<br/>
              <strong>Data:</strong> ${new Date(m.dataEnvio).toLocaleString()}
            </li>
          `).join('') + '</ul>';
      } else {
        container.innerHTML = `<p>‚ùå Erro ao carregar mensagens enviadas.</p>`;
        console.error(data);
      }
    }

    async function carregarNaoLidas() {
      const res = await fetch('/api/mensagens/nao-lidas', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      const data = await res.json();
      const container = document.getElementById('mensagensNaoLidas');

      if (Array.isArray(data) && data.length > 0) {
        container.innerHTML = '<ul>' + data.map(m => `
          <li>
            <strong>De (ID):</strong> ${m.senderId}<br/>
            <strong>Conte√∫do:</strong> ${m.conteudo}<br/>
            <strong>Data:</strong> ${new Date(m.dataEnvio).toLocaleString()}
          </li>
        `).join('') + '</ul>';
      } else {
        container.innerHTML = `<p>‚úÖ Nenhuma mensagem n√£o lida.</p>`;
      }
    }

    function escutarMensagensEmTempoReal(uid) {
      const mensagensRef = db.ref('mensagens/' + uid);
      mensagensRef.on('child_added', (snap) => {
        const m = snap.val();
        const container = document.getElementById('notificacoes');

        const alerta = document.createElement('div');
        alerta.style.border = '1px solid green';
        alerta.style.background = '#e1ffe1';
        alerta.style.marginTop = '10px';
        alerta.style.padding = '10px';
        alerta.innerHTML = `
          <strong>üì® Nova mensagem recebida!</strong><br/>
          <b>De:</b> ${m.senderId}<br/>
          <b>Conte√∫do:</b> ${m.conteudo}
        `;

        container.appendChild(alerta);
      });
    }

    init();
  </script>
</body>
</html>
